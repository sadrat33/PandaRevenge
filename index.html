<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Panda Puzzle - å®Œæ•´é–‹å ´å‹•ç•«ç‰ˆ</title>

<style>
/* ===== åŸºç¤æ¨£å¼ ===== */
body {
  margin: 0;
  font-family: "Noto Sans TC", sans-serif;
  background: #2b2b2b;
  color: #fff;
  overflow-x: hidden;
}

body.hammer { cursor: url("hammer.png") 32 32, auto; }
body.kid { cursor: url("pandaroom.png") 16 16, auto; }

/* é–‹å ´å°é¢æ¨£å¼ */
#startScreen {
  position: fixed;
  inset: 0;
  background: #1a1a1a;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 10000;
}

/* å½±ç‰‡å®¹å™¨æ¨£å¼ */
#videoContainer {
  position: fixed;
  inset: 0;
  background: #000;
  display: none; /* åˆå§‹éš±è— */
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.game-box {
  width: 800px;
  margin: 50px auto;
  background: #1f1f1f;
  padding: 30px;
  border-radius: 16px;
  text-align: center;
  position: relative;
  min-height: 600px;
}

button {
  padding: 12px 26px;
  border: none;
  border-radius: 6px;
  background: #ff5c5c;
  color: #fff;
  cursor: pointer;
  font-size: 16px;
}

button:hover { background: #ff7878; }

.scene { display: none; }

/* é ˜å–çå‹µæŒ‰éˆ•æ¨£å¼ */
.reward-btn {
  display: none; 
  margin-top: 30px;
  background: #ffc0cb; 
  color: #000; 
  border: 4px solid #fff;
  padding: 15px 35px;
  font-size: 22px;
  font-weight: bold;
  border-radius: 50px;
  cursor: pointer;
  box-shadow: 0 0 15px rgba(255,192,203,0.5);
}

/* ===== é£„æµ®æ–‡å­—èˆ‡é€šç”¨æ¨£å¼ ===== */
.score-float {
  position: absolute;
  font-weight: bold;
  pointer-events: none;
  z-index: 1000;
  animation: floatUp 1s forwards;
}
@keyframes floatUp {
  0% { transform: translateY(0); opacity: 1; }
  100% { transform: translateY(-50px); opacity: 0; }
}

.white-bg-black-text {
  background: #fff; color: #000; padding: 6px 16px; border-radius: 6px; font-weight: bold; margin-bottom: 10px; display: inline-block;
}

.black-bg-red-text {
  background: #000; color: #ff5c5c; padding: 10px 20px; border-radius: 8px; font-size: 24px; font-weight: bold; border: 2px solid #ff5c5c; margin: 10px;
}

/* ===== ç¬¬ä¸€é—œèˆ‡èµ°å»Š ===== */
.panda img { width: 320px; }
.hint { background: #333; padding: 14px; border-radius: 8px; margin: 18px 0; }
input { padding: 12px; width: 80%; border-radius: 6px; border: none; }
.door { animation: openDoor 1.5s forwards; }
@keyframes openDoor { to { transform: scaleX(0); opacity: 0; } }

#roomSelect { background: url("aisle.jpg") center/cover no-repeat; padding: 40px; border-radius: 14px; }
.door-selection { display: flex; justify-content: space-between; align-items: flex-end; }
.room-door { display: flex; flex-direction: column; align-items: center; }
.room-door img { width: 140px; }
.sign-img { width: 90px; cursor: pointer; margin-top: 8px; }

/* ===== æµ´å®¤ & å®¢å»³ ===== */
#bathroomScene { background: url("pandatub.png") center/cover no-repeat; height: 500px; border-radius: 14px; position: relative; }
#livingRoomScene { background: url("living room bg.png") center/cover no-repeat; height: 500px; border-radius: 14px; }
#bathGame { position: relative; height: 350px; overflow: hidden; }
.spawn { position: absolute; width: 90px; cursor: pointer; }

.slot-area { display: flex; justify-content: space-between; margin-top: 20px; }
.slot { width: 110px; height: 150px; border: 2px dashed #66ffff; border-radius: 10px; line-height: 150px; color: #66ffff; font-size: 24px; }
.card-area { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
.card { width: 100px; cursor: grab; }

/* ===== æˆ¿é–“é—œå¡ ===== */
#roomScene { 
  background: url("pandaroom.png") center/cover no-repeat; 
  height: 540px; border-radius: 14px; position: relative; overflow: hidden;
}
#bucket { position: absolute; bottom: 20px; width: 80px; left: 50%; transform: translateX(-50%); pointer-events: none; display: none; }
.ball { position: absolute; width: 45px; pointer-events: none; }
.room-hud { position: absolute; top: 10px; width: 100%; display: flex; justify-content: space-around; font-weight: bold; text-shadow: 1px 1px 3px #000; }
.room-result { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; }
</style>
</head>

<body>

<div id="startScreen">
  <div class="black-bg-red-text" style="font-size: 40px; margin-bottom: 30px;">PANDA REVENGE</div>
  <button onclick="playIntroVideo()" style="font-size: 24px; padding: 20px 50px; border-radius: 50px;">é–‹å§‹éŠæˆ²</button>
</div>

<div id="videoContainer">
  <video id="introVideo" width="100%" height="100%" style="object-fit: contain;">
    <source src="pandacry.mp4" type="video/mp4">
    ç€è¦½å™¨ä¸æ”¯æ´å½±ç‰‡ã€‚
  </video>
</div>

<div class="game-box">

  <div id="level1" class="scene">
    <h2>ç¬¬ä¸€é—œï¼šæ¨é–‹å¤§é–€</h2>
    <div class="panda"><img id="doorImg" src="opendoor.png"></div>
    <div class="hint">å“ªå€‹æ˜¯æ‚²å‚·å¤§é¼ æœ€å–œæ­¡çš„æš±ç¨±ï¼ˆå››å€‹å­—ï¼ŒåŒ…å«åœ°åï¼‰</div>
    <input id="answer" placeholder="è«‹è¼¸å…¥ç­”æ¡ˆ...">
    <br><br><button onclick="checkAnswer()">è§£é–</button>
  </div>

  <div id="roomSelect" class="scene">
    <div class="door-selection">
      <div class="room-door">
        <img src="æµ´å®¤é–€.png">
        <img src="æµ´å®¤é–€ç‰Œ.png" class="sign-img" onclick="enterBathroom()">
      </div>
      <div class="room-door">
        <img src="å®¢å»³é–€.png">
        <img src="å®¢å»³é–€ç‰Œ.png" class="sign-img" onclick="enterLivingRoom()">
      </div>
      <div class="room-door">
        <img src="æˆ¿é–“é–€.png">
        <img src="æˆ¿é–“é–€ç‰Œ.png" class="sign-img" onclick="enterPandaRoom()">
      </div>
    </div>
    <button id="claimRewardBtn" class="reward-btn" onclick="showReward()">ğŸ é ˜å–çå‹µ ğŸ</button>
  </div>

  <div id="bathroomScene" class="scene">
    <h2 class="white-bg-black-text">èª°è¦è·Ÿæœ¬è²“æ³¡æ¾¡</h2>
    <p class="white-bg-black-text">æ™‚é–“å…§æ‰“ä¸æ˜¯æƒ…å©¦çš„è§’è‰²ï¼Œ15åˆ†é€šé—œ</p>
    <div id="scoreWrap" style="display:none" class="white-bg-black-text">åˆ†æ•¸ï¼š<span id="bathScore">0</span>/15</div>
    <br><button id="bathStartBtn" onclick="startBathGame()">é–‹å§‹éŠæˆ²</button>
    <div id="bathGame"></div>
  </div>

  <div id="livingRoomScene" class="scene">
    <h2 class="white-bg-black-text">èº«ç‚ºç”·äººçš„è€ƒé©—</h2>
    <p class="white-bg-black-text">70ç§’å…§ä¾äº‹ä»¶ç™¼ç”Ÿæ™‚é–“æ’åˆ— (é åˆ°è¿‘)</p>
    <button onclick="startLivingGame()">é–‹å§‹æŒ‘æˆ°</button>
    <div id="livingGame" style="display:none">
      <div class="white-bg-black-text">â± <span id="timeText">70</span>s</div>
      <div class="slot-area">
        <div class="slot" data-slot="1">1</div>
        <div class="slot" data-slot="2">2</div>
        <div class="slot" data-slot="3">3</div>
        <div class="slot" data-slot="4">4</div>
        <div class="slot" data-slot="5">5</div>
      </div>
      <div class="card-area" id="cards"></div>
    </div>
  </div>

  <div id="roomScene" class="scene">
    <div id="roomStartUI">
      <div class="black-bg-red-text">è¨˜æ†¶ä¸­çš„å°å­©</div>
      <p class="white-bg-black-text">éŠæˆ²ç©æ³•ï¼š60ç§’å…§ç”¨æ¯å­æ¥ä½ä½ å¿ƒç›®ä¸­æœ€å¯æ„›ã€æœ€ç´”çœŸã€<br>
      è‚šè‚šæœ‰ä¸€é»é»??çš„é‚£ä½ï¼Œè¶…éæ™‚é–“æˆ–æ¥éŒ¯6æ¬¡ç‚ºæŒ‘æˆ°å¤±æ•—
      <br><button onclick="startRoomGame()">é–‹å§‹æ¥å°å­©</button>
    </div>
    
    <div id="roomHUD" class="room-hud" style="display:none">
      <span>â± <span id="roomTime">60</span></span>
      <span>â­ <span id="roomScore">0</span>/30</span>
      <span>âŒ <span id="roomMiss">0</span>/6</span>
    </div>
    <img id="bucket" src="bucket.png">
    <div id="roomResultArea" class="room-result" style="display:none"></div>
  </div>

  <div id="rewardScene" class="scene" style="background-color: #808080; padding: 20px;">
    <div class="black-bg-red-text">â¤ï¸ æœ€çµ‚é©šå–œ â¤ï¸</div>
    <img src="pandacon.png" style="width:300px; display:block; margin:20px auto;">
    <h2 style="color: #ffc0cb;">å¥½å§!åŸè«’ä½ ä¸€æ¬¡ï¼Œè«‹å¥½å¥½æ„›æˆ‘~</h2>
    <br>
    <button onclick="location.reload()">é‡æ–°é–‹å§‹éŠæˆ²</button>
</div>

</div>

<script>
/* ===== é–‹å ´å‹•ç•«é‚è¼¯ ===== */
const vContainer = document.getElementById('videoContainer');
const introVideo = document.getElementById('introVideo');
const startScreen = document.getElementById('startScreen');

function playIntroVideo() {
  // éš±è—å°é¢ï¼Œé¡¯ç¤ºå½±ç‰‡å®¹å™¨
  startScreen.style.display = 'none';
  vContainer.style.display = 'flex';
  
  // æ’­æ”¾å½±ç‰‡
  introVideo.play();
}

// ç•¶å½±ç‰‡çµæŸæ™‚è§¸ç™¼
introVideo.onended = function() {
  // å½±ç‰‡å®¹å™¨æ·¡å‡º
  vContainer.style.transition = "opacity 1s";
  vContainer.style.opacity = "0";
  
  setTimeout(() => {
    vContainer.style.display = "none";
    // é€²å…¥ç¬¬ä¸€é—œ
    showScene('level1');
  }, 1000);
};

/* ===== é€šç”¨é‚è¼¯èˆ‡é€šé—œç´€éŒ„ ===== */
let winBath = false;
let winLiving = false;
let winRoom = false;

function showScene(id){
  document.body.classList.remove("hammer", "kid");
  document.querySelectorAll(".scene").forEach(s=>s.style.display="none");
  const target = document.getElementById(id);
  if(target) target.style.display="block";

  if(id === 'roomSelect') {
    if(winBath && winLiving && winRoom) {
      document.getElementById('claimRewardBtn').style.display = 'inline-block';
    }
  }

  clearInterval(bathTimer); clearInterval(bathTimeTimer);
  clearInterval(livingTimer);
  stopRoomGame();
}

function showReward() {
  showScene('rewardScene');
}

function checkAnswer(){
  const ans = document.getElementById("answer").value.trim();
  if(ans === "è¡¨åƒé“é¼ "){
    document.getElementById("doorImg").classList.add("door");
    setTimeout(()=>showScene("roomSelect"), 1500);
  } else {
    alert("å¯†ç¢¼éŒ¯èª¤ï¼æç¤ºï¼šä»–ä½åœ¨æ±äº¬å“ªæ¢åè¡—ï¼Ÿ");
  }
}

/* ===== æµ´å®¤éŠæˆ²é‚è¼¯ ===== */
let bathScore = 0, bathTimer = null, bathTime = 60, bathTimeTimer = null;
const goodChars = ["notlover1.png", "notlover2.png", "notlover3.png", "notlover4.png"];
const badChars = ["lover1.png", "lover2.png", "lover3.png", "lover4.png", "lover5.png"];

function enterBathroom(){ showScene("bathroomScene"); document.getElementById("scoreWrap").style.display="none"; bathGame.innerHTML=""; }

function startBathGame(){
  document.body.classList.add("hammer");
  bathScore = 0; bathTime = 60;
  document.getElementById("scoreWrap").style.display="block";
  document.getElementById("bathScore").textContent = bathScore;
  bathGame.innerHTML = `<div class="white-bg-black-text">â± <span id="btText">60</span>s</div>`;
  
  bathTimeTimer = setInterval(()=>{
    bathTime--;
    document.getElementById("btText").textContent = bathTime;
    if(bathTime <= 0) endBath(false);
  }, 1000);

  bathTimer = setInterval(()=>{
    document.querySelectorAll(".spawn").forEach(e=>e.remove());
    [...goodChars, ...badChars].sort(()=>Math.random()-0.5).slice(0,4).forEach(src=>{
      const img = document.createElement("img");
      img.src = src; img.className = "spawn";
      img.style.left = Math.random()*80+"%"; img.style.top = Math.random()*70+"%";
      img.onclick = (e)=>{
        const txt = document.createElement("div");
        txt.className = "score-float";
        txt.style.left = e.pageX+"px"; txt.style.top = e.pageY+"px";
        if(goodChars.includes(src)){
          bathScore++; txt.textContent = "+1ï¼Œæ²’éŒ¯é€™ä¸æ˜¯æˆ‘çš„èœ"; txt.style.color = "lime";
        } else {
          bathScore--; txt.textContent = "-1ï¼Œä¸è¦äº‚æ‰“æƒ…å©¦ç—›ç—›"; txt.style.color = "red";
        }
        document.getElementById("bathScore").textContent = bathScore;
        document.body.appendChild(txt);
        img.remove();
        setTimeout(()=>txt.remove(), 800);
        if(bathScore >= 15) { winBath = true; endBath(true); }
      };
      bathGame.appendChild(img);
    });
  }, 1200); 
}

function endBath(win){
  clearInterval(bathTimer); clearInterval(bathTimeTimer);
  document.body.classList.remove("hammer");
  if(win) {
    bathGame.innerHTML = `
      <div style="text-align:center">
        <div class="black-bg-red-text">ğŸ‰ é€šé—œæˆåŠŸï¼ ğŸ‰</div>
        <img src="pandabath.png" style="width:220px; display:block; margin:15px auto;">
        <button onclick="showScene('roomSelect')">è¿”å›èµ°å»Š</button>
      </div>`;
  } else {
    bathGame.innerHTML = `<div class="black-bg-red-text">âŒ æŒ‘æˆ°å¤±æ•—</div><br><button onclick="showScene('roomSelect')">è¿”å›èµ°å»Š</button>`;
  }
}

/* ===== å®¢å»³éŠæˆ²é‚è¼¯ ===== */
let livingTime=70, livingTimer=null;
function enterLivingRoom(){ showScene("livingRoomScene"); document.getElementById("livingGame").style.display="none"; }
function startLivingGame(){
  document.getElementById("livingGame").style.display="block";
  const cardsBox = document.getElementById("cards");
  cardsBox.innerHTML="";
  livingTime=70;
  document.getElementById("timeText").textContent = livingTime;
  clearInterval(livingTimer);
  livingTimer = setInterval(()=>{
    livingTime--;
    document.getElementById("timeText").textContent = livingTime;
    if(livingTime<=0){ clearInterval(livingTimer); alert("æ™‚é–“åˆ°ï¼æŒ‘æˆ°å¤±æ•—"); showScene('roomSelect'); }
  },1000);

  ["1","2","3","4","5"].sort(()=>Math.random()-0.5).forEach(n=>{
    let img = document.createElement("img");
    img.src = "living"+n+".png"; img.className = "card"; img.draggable = true;
    img.dataset.num = n;
    img.ondragstart = e => e.dataTransfer.setData("num", n);
    cardsBox.appendChild(img);
  });

  document.querySelectorAll(".slot").forEach(slot=>{
    slot.innerHTML = slot.dataset.slot;
    slot.ondragover = e => e.preventDefault();
    slot.ondrop = e => {
      let n = e.dataTransfer.getData("num");
      slot.innerHTML = "";
      let img = document.createElement("img");
      img.src = "living"+n+".png"; img.dataset.num = n; img.style.width="100%";
      slot.appendChild(img);
      checkLivingWin();
    };
  });
}
function checkLivingWin(){
  let ok = true;
  document.querySelectorAll(".slot").forEach(s=>{
    if(!s.firstChild || s.firstChild.dataset.num !== s.dataset.slot) ok = false;
  });
  if(ok){
    winLiving = true;
    clearInterval(livingTimer);
    document.getElementById("livingGame").innerHTML = `
      <div style="text-align:center">
        <div class="black-bg-red-text">ğŸ‰ é€šé—œæˆåŠŸï¼ ğŸ‰</div>
        <img src="pandafamily.png" style="width:220px; display:block; margin:15px auto;">
        <button onclick="showScene('roomSelect')">è¿”å›èµ°å»Š</button>
      </div>`;
  }
} 

/* ===== æˆ¿é–“(æ¥å°å­©)é‚è¼¯ ===== */
let rTime=60, rScore=0, rMiss=0, rSpawnInterval, rTimerInterval, rAnimFrame;
const rBucket = document.getElementById("bucket");

function enterPandaRoom(){ showScene("roomScene"); document.getElementById("roomStartUI").style.display="block"; document.getElementById("roomHUD").style.display="none"; rBucket.style.display="none"; document.getElementById("roomResultArea").style.display="none"; }

function startRoomGame(){
  document.getElementById("roomStartUI").style.display="none";
  document.getElementById("roomHUD").style.display="flex";
  rBucket.style.display="block";
  rScore = 0; rMiss = 0; rTime = 60;
  updateRoomHUD();
  rTimerInterval = setInterval(()=>{
    rTime--;
    document.getElementById("roomTime").textContent = rTime;
    if(rTime <= 0) endRoomGame(false);
  }, 1000);
  rSpawnInterval = setInterval(spawnBalls, 300);
  rAnimFrame = requestAnimationFrame(updateBalls);
}

function spawnBalls(){
  const pool = ["panda.png", "rat.png", "pandarat.png", "ratpanda.png"];
  const img = document.createElement("img");
  img.src = pool[Math.floor(Math.random()*pool.length)];
  img.className = "ball";
  const sceneWidth = document.getElementById("roomScene").offsetWidth;
  img.style.left = Math.random()*(sceneWidth - 50) + "px";
  img.style.top = "-50px";
  img.dataset.speed = 4.7; 
  document.getElementById("roomScene").appendChild(img);
}

function updateBalls(){
  document.querySelectorAll(".ball").forEach(ball => {
    ball.style.top = (parseFloat(ball.style.top) + parseFloat(ball.dataset.speed)) + "px";
    if(checkHit(ball)){
      if(ball.src.includes("rat.png") || ball.src.includes("ratpanda.png")){ rScore++; }
      else { rScore--; rMiss++; }
      updateRoomHUD();
      ball.remove();
      if(rScore >= 30) { winRoom = true; endRoomGame(true); }
      if(rMiss >= 6) endRoomGame(false);
    } else if(parseFloat(ball.style.top) > 540){
      ball.remove();
    }
  });
  rAnimFrame = requestAnimationFrame(updateBalls);
}

function checkHit(ball){
  const b = ball.getBoundingClientRect();
  const c = rBucket.getBoundingClientRect();
  return !(b.right < c.left || b.left > c.right || b.bottom < c.top || b.top > c.bottom);
}

function updateRoomHUD(){
  document.getElementById("roomScore").textContent = rScore;
  document.getElementById("roomMiss").textContent = rMiss;
}

function endRoomGame(win){
  stopRoomGame();
  const res = document.getElementById("roomResultArea");
  res.style.display = "flex";
  if(win) {
    res.innerHTML = `
      <div style="text-align:center">
        <div class="black-bg-red-text">ğŸ‰ é€šé—œæˆåŠŸï¼ ğŸ‰</div>
        <img src="ratlove.png" style="width:220px; display:block; margin:15px auto;">
        <button onclick="showScene('roomSelect')">è¿”å›èµ°å»Š</button>
      </div>`;
  } else {
    res.innerHTML = `<div>ğŸ’” æŒ‘æˆ°å¤±æ•—</div><br><button onclick="showScene('roomSelect')">è¿”å›èµ°å»Š</button>`;
  }
}

function stopRoomGame(){
  clearInterval(rSpawnInterval); clearInterval(rTimerInterval);
  cancelAnimationFrame(rAnimFrame);
  document.querySelectorAll(".ball").forEach(b=>b.remove());
}

document.getElementById("roomScene").addEventListener("mousemove", e => {
  const rect = document.getElementById("roomScene").getBoundingClientRect();
  let x = e.clientX - rect.left - rBucket.offsetWidth/2;
  if(x < 0) x = 0;
  if(x > rect.width - rBucket.offsetWidth) x = rect.width - rBucket.offsetWidth;
  rBucket.style.left = x + "px";
});
</script>

</body>
</html>
